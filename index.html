<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Chat - Encrypted Messaging</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: #666;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .toggle-auth {
            text-align: center;
            margin-top: 20px;
        }

        .toggle-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
        }

        .toggle-link:hover {
            text-decoration: underline;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
        }

        .logout-btn {
            padding: 8px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn:hover {
            background: #e0e0e0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-new-chat, .btn-new-group {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-new-chat {
            background: #667eea;
            color: white;
        }

        .btn-new-chat:hover {
            background: #5568d3;
        }

        .btn-new-group {
            background: #764ba2;
            color: white;
        }

        .btn-new-group:hover {
            background: #653a8a;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: #f9f9f9;
        }

        .chat-item.active {
            background: #e8eaf6;
        }

        .chat-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .chat-avatar.private {
            background: #667eea;
        }

        .chat-avatar.group {
            background: #764ba2;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .chat-last-message {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }

        .chat-header {
            background: white;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .chat-header-info h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .encrypted-label {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.sent .message-bubble {
            background: #667eea;
            color: white;
        }

        .message.received .message-bubble {
            background: white;
            color: #333;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .message-text {
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .message-input-container {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 16px 20px;
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .image-upload-btn {
            padding: 8px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload-btn:hover {
            background: #e0e0e0;
        }

        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: #5568d3;
        }

        .empty-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #999;
        }

        .empty-icon {
            margin-bottom: 16px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f5f5f5;
        }

        .modal-search {
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            position: relative;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f9f9f9;
        }

        .user-item.selected {
            background: #f3e5f5;
        }

        .user-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-avatar.default {
            background: #667eea;
        }

        .user-avatar.selected {
            background: #764ba2;
        }

        .user-info-modal {
            flex: 1;
        }

        .user-display-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 14px;
            color: #666;
        }

        .check-mark {
            width: 20px;
            height: 20px;
            background: #764ba2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
        }

        .group-name-input {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .group-name-input:focus {
            outline: none;
            border-color: #764ba2;
        }

        .create-group-btn {
            width: 100%;
            padding: 12px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .create-group-btn:hover {
            background: #653a8a;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
            }

            .main-chat {
                width: 100%;
            }

            .sidebar.has-active-chat {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon">
                    <i data-lucide="lock" style="width: 32px; height: 32px; color: white;"></i>
                </div>
                <h1 class="login-title">Secure Chat</h1>
                <p class="login-subtitle">End-to-end encrypted messaging</p>
            </div>

            <div id="authForm">
                <div id="displayNameGroup" class="input-group hidden">
                    <input type="text" id="displayName" class="input-field" placeholder="Display Name">
                </div>
                <div class="input-group">
                    <input type="email" id="email" class="input-field" placeholder="Email" required>
                </div>
                <div class="input-group">
                    <input type="password" id="password" class="input-field" placeholder="Password" required minlength="6">
                </div>

                <div id="errorMessage" class="error-message hidden"></div>

                <button id="authButton" class="btn-primary">Login</button>
            </div>

            <div class="toggle-auth">
                <a id="toggleAuth" class="toggle-link">Don't have an account? Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="chat-container hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <h2 id="currentUserName" class="user-name"></h2>
                    <button id="logoutBtn" class="logout-btn">
                        <i data-lucide="log-out" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>

                <div class="action-buttons">
                    <button id="newChatBtn" class="btn-new-chat">
                        <i data-lucide="message-circle" style="width: 16px; height: 16px;"></i>
                        New Chat
                    </button>
                    <button id="newGroupBtn" class="btn-new-group">
                        <i data-lucide="users" style="width: 16px; height: 16px;"></i>
                        New Group
                    </button>
                </div>
            </div>

            <div id="chatList" class="chat-list"></div>
        </div>

        <!-- Main Chat -->
        <div class="main-chat">
            <div id="emptyState" class="empty-state">
                <div class="empty-icon">
                    <i data-lucide="message-circle" style="width: 64px; height: 64px; color: #ccc;"></i>
                </div>
                <h3 style="font-size: 20px; margin-bottom: 8px;">Select a chat to start messaging</h3>
                <p>All messages are encrypted with base64</p>
            </div>

            <div id="chatArea" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <div class="chat-header">
                    <div class="chat-header-content">
                        <div id="chatHeaderAvatar" class="chat-header-avatar"></div>
                        <div class="chat-header-info">
                            <h2 id="chatHeaderName"></h2>
                            <div class="encrypted-label">
                                <i data-lucide="lock" style="width: 12px; height: 12px;"></i>
                                End-to-end encrypted
                            </div>
                        </div>
                    </div>
                </div>

                <div id="messagesContainer" class="messages-container"></div>

                <div class="message-input-container">
                    <div class="message-input-wrapper">
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        <button id="imageUploadBtn" class="image-upload-btn">
                            <i data-lucide="image" style="width: 20px; height: 20px;"></i>
                        </button>
                        <input type="text" id="messageInput" class="message-input" placeholder="Type a message...">
                        <button id="sendBtn" class="send-btn">
                            <i data-lucide="send" style="width: 20px; height: 20px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Chat</h3>
                <button id="closeNewChatModal" class="close-btn">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-search">
                <div class="search-wrapper">
                    <i data-lucide="search" class="search-icon" style="width: 20px; height: 20px;"></i>
                    <input type="text" id="userSearchInput" class="search-input" placeholder="Search users..." style="padding-left: 40px;">
                </div>
            </div>
            <div id="userList" class="modal-body">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- New Group Modal -->
    <div id="newGroupModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Group</h3>
                <button id="closeNewGroupModal" class="close-btn">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-search">
                <input type="text" id="groupNameInput" class="group-name-input" placeholder="Group name">
                <div id="groupErrorMessage" class="error-message hidden" style="margin-top: 8px;"></div>
            </div>
            <div id="groupUserList" class="modal-body">
                <div class="loading">Loading users...</div>
            </div>
            <div class="modal-footer">
                <button id="createGroupBtn" class="create-group-btn">Create Group (0 members)</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, getDocs, doc, setDoc, getDoc, serverTimestamp, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjFAmFLH07JkEmL9jmXB3Suu6dC1xUvVM",
            authDomain: "chat2o-33113.firebaseapp.com",
            projectId: "chat2o-33113",
            storageBucket: "chat2o-33113.firebasestorage.app",
            messagingSenderId: "1074856844276",
            appId: "1:1074856844276:web:09e8f7728adb3c7a3db7a1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let activeChat = null;
        let isSignUp = false;
        let selectedUsers = [];
        let unsubscribeMessages = null;
        let unsubscribeChats = null;

        // Encryption functions
        function encryptMessage(message) {
            return btoa(unescape(encodeURIComponent(message)));
        }

        function decryptMessage(encrypted) {
            try {
                return decodeURIComponent(escape(atob(encrypted)));
            } catch (e) {
                return encrypted;
            }
        }

        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const chatScreen = document.getElementById('chatScreen');
        const authButton = document.getElementById('authButton');
        const toggleAuth = document.getElementById('toggleAuth');
        const displayNameGroup = document.getElementById('displayNameGroup');
        const errorMessage = document.getElementById('errorMessage');
        const currentUserName = document.getElementById('currentUserName');
        const logoutBtn = document.getElementById('logoutBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const newGroupBtn = document.getElementById('newGroupBtn');
        const chatList = document.getElementById('chatList');
        const emptyState = document.getElementById('emptyState');
        const chatArea = document.getElementById('chatArea');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const imageUploadBtn = document.getElementById('imageUploadBtn');
        const imageUpload = document.getElementById('imageUpload');
        const newChatModal = document.getElementById('newChatModal');
        const newGroupModal = document.getElementById('newGroupModal');
        const closeNewChatModal = document.getElementById('closeNewChatModal');
        const closeNewGroupModal = document.getElementById('closeNewGroupModal');
        const userList = document.getElementById('userList');
        const groupUserList = document.getElementById('groupUserList');
        const userSearchInput = document.getElementById('userSearchInput');
        const groupNameInput = document.getElementById('groupNameInput');
        const createGroupBtn = document.getElementById('createGroupBtn');
        const groupErrorMessage = document.getElementById('groupErrorMessage');

        // Toggle between login and signup
        toggleAuth.addEventListener('click', () => {
            isSignUp = !isSignUp;
            authButton.textContent = isSignUp ? 'Sign Up' : 'Login';
            toggleAuth.textContent = isSignUp ? 'Already have an account? Login' : "Don't have an account? Sign Up";
            displayNameGroup.classList.toggle('hidden', !isSignUp);
            errorMessage.classList.add('hidden');
        });

        // Authentication
        authButton.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const displayName = document.getElementById('displayName').value;

            errorMessage.classList.add('hidden');
            authButton.disabled = true;
            authButton.textContent = 'Please wait...';

            try {
                if (isSignUp) {
                    if (!displayName.trim()) {
                        throw new Error('Display name is required');
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: displayName });

                    // Create user document in Firestore
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        uid: userCredential.user.uid,
                        email: email,
                        displayName: displayName,
                        createdAt: serverTimestamp()
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                errorMessage.textContent = err.message;
                errorMessage.classList.remove('hidden');
                authButton.disabled = false;
                authButton.textContent = isSignUp ? 'Sign Up' : 'Login';
            }
        });

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0]
                };
                showChatScreen();
            } else {
                currentUser = null;
                activeChat = null;
                loginScreen.classList.remove('hidden');
                chatScreen.classList.add('hidden');
                authButton.disabled = false;
                authButton.textContent = isSignUp ? 'Sign Up' : 'Login';
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeChats) unsubscribeChats();
                await signOut(auth);
            } catch (err) {
                console.error('Logout error:', err);
            }
        });

        // Show chat screen
        function showChatScreen() {
            loginScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            currentUserName.textContent = currentUser.displayName;
            loadChatsAndGroups();
            lucide.createIcons();
        }

        // Load chats and groups
        async function loadChatsAndGroups() {
            chatList.innerHTML = '<div class="loading">Loading chats...</div>';

            try {
                // Listen to groups
                const groupsQuery = query(
                    collection(db, 'groups'),
                    where('members', 'array-contains', currentUser.uid)
                );

                unsubscribeChats = onSnapshot(groupsQuery, async (snapshot) => {
                    const groups = [];
                    snapshot.forEach(doc => {
                        groups.push({ id: doc.id, ...doc.data() });
                    });

                    // Get private chats
                    const chatsQuery = query(
                        collection(db, 'chats'),
                        where('participants', 'array-contains', currentUser.uid)
                    );

                    const chatsSnapshot = await getDocs(chatsQuery);
                    const chats = [];
                    chatsSnapshot.forEach(doc => {
                        chats.push({ id: doc.id, ...doc.data() });
                    });

                    renderChatList(groups, chats);
                });

            } catch (err) {
                console.error('Error loading chats:', err);
                chatList.innerHTML = '<div class="loading">Error loading chats</div>';
            }
        }

        // Render chat list
        async function renderChatList(groups, chats) {
            chatList.innerHTML = '';

            // Render groups
            for (const group of groups) {
                const chatItem = await createChatItem(group, true);
                chatList.appendChild(chatItem);
            }

            // Render private chats
            for (const chat of chats) {
                const otherUserId = chat.participants.find(p => p !== currentUser.uid);
                const userDoc = await getDoc(doc(db, 'users', otherUserId));
                const userData = userDoc.data();

                const chatData = {
                    id: chat.id,
                    name: userData.displayName,
                    lastMessage: chat.lastMessage,
                    otherUserId: otherUserId
                };

                const chatItem = await createChatItem(chatData, false);
                chatList.appendChild(chatItem);
            }

            if (groups.length === 0 && chats.length === 0) {
                chatList.innerHTML = '<div class="loading">No chats yet. Start a new conversation!</div>';
            }

            lucide.createIcons();
        }

        // Create chat item
        async function createChatItem(chat, isGroup) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            if (activeChat && activeChat.id === chat.id) {
                div.classList.add('active');
            }

            const avatarClass = isGroup ? 'group' : 'private';
            const avatarContent = isGroup 
                ? '<i data-lucide="users" style="width: 24px; height: 24px;"></i>' 
                : chat.name[0].toUpperCase();

            const lastMsg = chat.lastMessage ? decryptMessage(chat.lastMessage) : 'No messages yet';

            div.innerHTML = `
                <div class="chat-item-content">
                    <div class="chat-avatar ${avatarClass}">${avatarContent}</div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-last-message">${lastMsg}</div>
                    </div>
                </div>
            `;

            div.addEventListener('click', () => {
                activeChat = { ...chat, isGroup };
                if (!isGroup) {
                    activeChat.otherUserId = chat.otherUserId;
                }
                loadMessages();
                showChatArea();
                loadChatsAndGroups();
            });

            return div;
        }

        // Show chat area
        function showChatArea() {
            emptyState.classList.add('hidden');
            chatArea.classList.remove('hidden');

            const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
            const chatHeaderName = document.getElementById('chatHeaderName');

            if (activeChat.isGroup) {
                chatHeaderAvatar.className = 'chat-header-avatar';
                chatHeaderAvatar.style.background = '#764ba2';
                chatHeaderAvatar.innerHTML = '<i data-lucide="users" style="width: 20px; height: 20px;"></i>';
            } else {
                chatHeaderAvatar.className = 'chat-header-avatar';
                chatHeaderAvatar.style.background = '#667eea';
                chatHeaderAvatar.textContent = activeChat.name[0].toUpperCase();
            }

            chatHeaderName.textContent = activeChat.name;
            lucide.createIcons();
        }

        // Load messages
        function loadMessages() {
            messagesContainer.innerHTML = '<div class="loading">Loading messages...</div>';

            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            try {
                const messagesQuery = query(
                    collection(db, activeChat.isGroup ? 'groups' : 'chats', activeChat.id, 'messages'),
                    orderBy('timestamp', 'asc')
                );

                unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        const messageEl = createMessageElement(msg);
                        messagesContainer.appendChild(messageEl);
                    });

                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    lucide.createIcons();
                });

            } catch (err) {
                console.error('Error loading messages:', err);
                messagesContainer.innerHTML = '<div class="loading">Error loading messages</div>';
            }
        }

        // Create message element
        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = msg.senderId === currentUser.uid ? 'message sent' : 'message received';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (activeChat.isGroup && msg.senderId !== currentUser.uid) {
                const sender = document.createElement('div');
                sender.className = 'message-sender';
                sender.textContent = msg.senderName;
                bubble.appendChild(sender);
            }

            if (msg.type === 'text') {
                const text = document.createElement('div');
                text.className = 'message-text';
                text.textContent = decryptMessage(msg.text);
                bubble.appendChild(text);
            } else if (msg.type === 'image') {
                const img = document.createElement('img');
                img.className = 'message-image';
                img.src = msg.image;
                bubble.appendChild(img);
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            const date = msg.timestamp ? new Date(msg.timestamp.toDate()) : new Date();
            time.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            bubble.appendChild(time);

            div.appendChild(bubble);
            return div;
        }

        // Send message
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !activeChat) return;

            try {
                const message = {
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: encryptMessage(text),
                    timestamp: serverTimestamp(),
                    type: 'text'
                };

                await addDoc(
                    collection(db, activeChat.isGroup ? 'groups' : 'chats', activeChat.id, 'messages'),
                    message
                );

                // Update last message
                await updateDoc(
                    doc(db, activeChat.isGroup ? 'groups' : 'chats', activeChat.id),
                    {
                        lastMessage: encryptMessage(text),
                        lastMessageTime: serverTimestamp()
                    }
                );

                messageInput.value = '';
            } catch (err) {
                console.error('Error sending message:', err);
                alert('Failed to send message');
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Upload image
        imageUploadBtn.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !activeChat) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const message = {
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName,
                        image: event.target.result,
                        timestamp: serverTimestamp(),
                        type: 'image'
                    };

                    await addDoc(
                        collection(db, activeChat.isGroup ? 'groups' : 'chats', activeChat.id, 'messages'),
                        message
                    );

                    // Update last message
                    await updateDoc(
                        doc(db, activeChat.isGroup ? 'groups' : 'chats', activeChat.id),
                        {
                            lastMessage: 'ðŸ“· Image',
                            lastMessageTime: serverTimestamp()
                        }
                    );

                    imageUpload.value = '';
                } catch (err) {
                    console.error('Error sending image:', err);
                    alert('Failed to send image');
                }
            };
            reader.readAsDataURL(file);
        });

        // New chat modal
        newChatBtn.addEventListener('click', () => {
            newChatModal.classList.remove('hidden');
            loadUsers();
            lucide.createIcons();
        });

        closeNewChatModal.addEventListener('click', () => {
            newChatModal.classList.add('hidden');
            userSearchInput.value = '';
        });

        // Load users
        async function loadUsers(searchQuery = '') {
            userList.innerHTML = '<div class="loading">Loading users...</div>';

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid &&
                        userData.displayName.toLowerCase().includes(searchQuery.toLowerCase())) {
                        users.push(userData);
                    }
                });

                userList.innerHTML = '';

                if (users.length === 0) {
                    userList.innerHTML = '<div class="loading">No users found</div>';
                    return;
                }

                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `
                        <div class="user-item-content">
                            <div class="user-avatar default">${user.displayName[0].toUpperCase()}</div>
                            <div class="user-info-modal">
                                <div class="user-display-name">${user.displayName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    `;

                    div.addEventListener('click', async () => {
                        await startPrivateChat(user);
                    });

                    userList.appendChild(div);
                });

                lucide.createIcons();
            } catch (err) {
                console.error('Error loading users:', err);
                userList.innerHTML = '<div class="loading">Error loading users</div>';
            }
        }

        userSearchInput.addEventListener('input', (e) => {
            loadUsers(e.target.value);
        });

        // Start private chat
        async function startPrivateChat(user) {
            try {
                // Check if chat already exists
                const chatsQuery = query(
                    collection(db, 'chats'),
                    where('participants', 'array-contains', currentUser.uid)
                );

                const chatsSnapshot = await getDocs(chatsQuery);
                let existingChat = null;

                chatsSnapshot.forEach(doc => {
                    const chatData = doc.data();
                    if (chatData.participants.includes(user.uid)) {
                        existingChat = { id: doc.id, ...chatData };
                    }
                });

                if (existingChat) {
                    activeChat = {
                        id: existingChat.id,
                        name: user.displayName,
                        isGroup: false,
                        otherUserId: user.uid
                    };
                } else {
                    // Create new chat
                    const chatRef = await addDoc(collection(db, 'chats'), {
                        participants: [currentUser.uid, user.uid],
                        createdAt: serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: serverTimestamp()
                    });

                    activeChat = {
                        id: chatRef.id,
                        name: user.displayName,
                        isGroup: false,
                        otherUserId: user.uid
                    };
                }

                newChatModal.classList.add('hidden');
                userSearchInput.value = '';
                loadMessages();
                showChatArea();
                loadChatsAndGroups();
            } catch (err) {
                console.error('Error starting chat:', err);
                alert('Failed to start chat');
            }
        }

        // New group modal
        newGroupBtn.addEventListener('click', () => {
            newGroupModal.classList.remove('hidden');
            selectedUsers = [];
            groupNameInput.value = '';
            groupErrorMessage.classList.add('hidden');
            loadGroupUsers();
            updateCreateGroupButton();
            lucide.createIcons();
        });

        closeNewGroupModal.addEventListener('click', () => {
            newGroupModal.classList.add('hidden');
        });

        // Load group users
        async function loadGroupUsers() {
            groupUserList.innerHTML = '<div class="loading">Loading users...</div>';

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];

                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.uid !== currentUser.uid) {
                        users.push(userData);
                    }
                });

                groupUserList.innerHTML = '';

                if (users.length === 0) {
                    groupUserList.innerHTML = '<div class="loading">No users available</div>';
                    return;
                }

                users.forEach(user => {
                    const isSelected = selectedUsers.includes(user.uid);
                    const div = document.createElement('div');
                    div.className = 'user-item' + (isSelected ? ' selected' : '');
                    div.innerHTML = `
                        <div class="user-item-content">
                            <div class="user-avatar ${isSelected ? 'selected' : 'default'}">${user.displayName[0].toUpperCase()}</div>
                            <div class="user-info-modal">
                                <div class="user-display-name">${user.displayName}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                            ${isSelected ? '<div class="check-mark">âœ“</div>' : ''}
                        </div>
                    `;

                    div.addEventListener('click', () => {
                        if (selectedUsers.includes(user.uid)) {
                            selectedUsers = selectedUsers.filter(id => id !== user.uid);
                        } else {
                            selectedUsers.push(user.uid);
                        }
                        loadGroupUsers();
                        updateCreateGroupButton();
                    });

                    groupUserList.appendChild(div);
                });

                lucide.createIcons();
            } catch (err) {
                console.error('Error loading users:', err);
                groupUserList.innerHTML = '<div class="loading">Error loading users</div>';
            }
        }

        // Update create group button
        function updateCreateGroupButton() {
            createGroupBtn.textContent = `Create Group (${selectedUsers.length} members)`;
        }

        // Create group
        createGroupBtn.addEventListener('click', async () => {
            const groupName = groupNameInput.value.trim();
            groupErrorMessage.classList.add('hidden');

            if (!groupName) {
                groupErrorMessage.textContent = 'Group name is required';
                groupErrorMessage.classList.remove('hidden');
                return;
            }

            if (selectedUsers.length === 0) {
                groupErrorMessage.textContent = 'Select at least one member';
                groupErrorMessage.classList.remove('hidden');
                return;
            }

            try {
                createGroupBtn.disabled = true;
                createGroupBtn.textContent = 'Creating...';

                await addDoc(collection(db, 'groups'), {
                    name: groupName,
                    members: [currentUser.uid, ...selectedUsers],
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    lastMessage: '',
                    lastMessageTime: serverTimestamp()
                });

                newGroupModal.classList.add('hidden');
                createGroupBtn.disabled = false;
                updateCreateGroupButton();
                loadChatsAndGroups();
            } catch (err) {
                console.error('Error creating group:', err);
                groupErrorMessage.textContent = 'Failed to create group';
                groupErrorMessage.classList.remove('hidden');
                createGroupBtn.disabled = false;
                updateCreateGroupButton();
            }
        });

        // Initialize icons
        lucide.createIcons();
    </script>
</body>
</html>
